<script type="text/javascript">
window.onload = function() {
//Beginning windows onload
    $.ajaxSetup({
      beforeSend: function(xhr, settings) {
           if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
               xhr.setRequestHeader("X-CSRFToken", $("#csrf_token").attr("value"));
               }
           }
    });

    var topics = [];
    var formats = [];
    $.ajax({
      url: '/api/v1/topics',
      type: 'GET',
      error: function() {
          console.log("unable to retrieve topics");
      },
      success: function(res) {
         topics = res.result;
         initTopicSelectize ();
      }
    });
    $.ajax({
      url: '/api/v1/supported',
      type: 'GET',
      error: function() {
          console.log("unable to retrieve supported formats");
      },
      success: function(res) {
         formats = res.result;
         initContentTypeSelectize ();
      }
    });

    function initTopicSelectize () {
      $('#topics').selectize({
        delimiter: ',',
        persist: false,
        options: topics,
        valueField: "key",
        sortField: 'name',
        searchField: ['name', 'description'],
        render: {
          item: function(item, escape) {
              return '<div>' +
                  (item.name ? '<span class="name">' + escape(item.name) + '</span>' : '')
              '</div>';
          },
          option: function(item, escape) {
              var label = item.name || item.description;
              var caption = item.name ? item.description : null;
              return '<div>' +
                  '<span class="label">' + escape(label) + ' </span>' +
                  (caption ? '<span class="caption"> ' + escape(caption) + '</span>' : '') +
              '</div>';
          },
        }
      });
    };

    function initContentTypeSelectize () {
      $('#is_a').selectize({
          delimiter: ',',
          persist: false,
          onItemAdd: appendFormField,
          options: formats,
          maxItems: 1,
          valueField: "name",
          sortField: 'name',
          searchField: ['name', 'description'],
          render: {
            item: function(item, escape) {
                return '<div>' +
                    (item.name ? '<span class="name">' + escape(item.name) + '</span>' : '')
                '</div>';
            },
            option: function(item, escape) {
                var label = item.name || item.description;
                var caption = item.name ? item.description : null;
                return '<div>' +
                    '<span class="label">' + escape(label) + ' </span>' +
                    (caption ? '<span class="caption"> ' + escape(caption) + '</span>' : '') +
                '</div>';
            },
          }
      });
    };

    function appendFormField (value, $item){
      $("#content-form-field").html(ContentFields[value]);
    };

    $("#new-lesson-form").submit(function(event) {
      event.preventDefault();
      var form = $(this);
      $.ajax({
        url: form.attr('action'),
        type: form.attr('method'),
        data: form.serialize(),
        error: function() {
            $("#notifications").html("<div class='alert alert-dismissable alert-danger'><button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>"+ "Failed to submit form" +"</div>");
            $("#submit-form-btn").html("Retry").removeClass("disabled").removeAttr("disabled");
        },
        success: function(res) {
          var nexStep="<p>Your lesson has been created and waiting to be approved by a moderator. Click below to view or create a quiz for the lesson. Thank you for your contribution!</p>";
          var nexStepBtn= "<div class='row'><a href='/lesson/"+ res.result.lesson + "/' class='btn btn-primary'>"+"View lesson"+"</a><a href='/quiz/"+ res.result.lesson + "/create' class='btn btn-primary'>"+"Make a quiz for lesson."+"</a></div>";
          $("#new-lesson-form-container").html(nexStep+nexStepBtn);
          console.log(res);
        }
      });
    });

//End of Winloads onload 
};
</script>